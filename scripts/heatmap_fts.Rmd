---
title: "heatmap_fts"
author: "Jordan Lee"
date: "11/24/2020"
output: html_document
---

Best model per team. Based on `mean overall weighted F1`. Samples not clustered, features clustered.

```{r, echo = FALSE}

suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(data.table))
```
```{r}
# Hardcoded 
cancer <- 'BRCA'
df <- fread('../data/heatmap/BRCA_fts_by_VALUE.tsv') %>% as.data.frame()
df_fts <- fread('../data/heatmap/BRCA_fts_by_TEAM.tsv')%>% as.data.frame()

```

# testing if can pull order of rows and col, for sanity check

```{r for single data type, eval=FALSE, include=FALSE}
####
# Main
####
prefix <- 'I:CNVR'

# A. Order by subtype
df_transform <- df %>% arrange(Labels)

# B. Column annotation
column_ha <- HeatmapAnnotation(
  Subtype = df_transform$Labels, 
  na_col = 'grey', 
  col = list(
    Subtype = c(
      "BRCA_1" = 'royalblue4',
      "BRCA_2"='royalblue1',
      "BRCA_3"='paleturquoise3',
      "BRCA_4"='paleturquoise1'
    )
  )
)

# C. Select data type
df_transform <- df_transform %>%
    select(-Labels) %>%
    select(-all_of(cancer)) %>%
    select(starts_with(prefix))
mat <- df_transform %>%
    as.matrix() %>%
    t()
print(prefix)
n_fts <- nrow(mat)
print(n_fts)

# 1. Heatmap that applies clustering we want
#    second heatmap same row/col order but with added annotation bars
fig <- Heatmap(
  mat,
  name = 'first heatmap',
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = FALSE,
  column_title = 'Samples',
  row_title = 'Features',
  top_annotation = column_ha
)
draw(fig)

#### 
# new
####

# Ordering
# 1. Get order of features post heatmap clustering
heatmap_order <- row_order(fig) # index vector
ftnames_order <- c() # featurename vector
for (i in heatmap_order){
  add_ft <- colnames(df_transform)[i]
  ftnames_order <- c(ftnames_order, add_ft)
}
print(ftnames_order)
# 2. Get new matrix that is ordered by heatmap clustering
mat2 <- mat[match(ftnames_order, rownames(mat)),]



# Build annotation bars of teams feature sets. 
# 1. df of all teams. match ft order in heatmap
team_df<- df_fts %>% filter(featureID %in% ftnames_order) %>% arrange(match(featureID, ftnames_order))
# 2. Pull just the team of interest
jadbio <- team_df %>% pull('gnosis_1_BRCA') %>% as.character()
cforest <- team_df %>% pull('CF|All_Top 100_BRCA') %>% as.character()
aklimate <- team_df %>% pull('AKLIMATE_BRCA_reduced_model_1000_feature_set_BRCA') %>% as.character()
subscope <- team_df %>% pull('nn_jg_2020-03-20_top1kfreq:BRCA_BRCA') %>% as.character()
skgrid <- team_df %>% pull('fbedeBIC_BRCA') %>% as.character()
team_list <- rowAnnotation(
  JadBIO = jadbio,
  CForest = cforest,
  AKLIMATE = aklimate,
  SubSCOPE = subscope,
  SKGrid = skgrid,
  col = list(
    JadBIO = c('0' = "snow2", '1' = "palevioletred1"),
    CForest =  c('0' = "snow2", '1' = "mediumpurple1"),
    AKLIMATE =  c('0' = "snow2", '1' = "cadetblue1"),
    SubSCOPE =  c('0' = "snow2", '1' = "palegreen2"),
    SKGrid =  c('0' = "snow2", '1' = "rosybrown2")
  ),
  show_legend = FALSE
)
# 3. Heatmap
fig <- Heatmap(
  mat2,
  name = prefix,
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = FALSE,
  column_title = 'Samples',
  row_title = 'Features',
  top_annotation = column_ha,
  right_annotation = team_list
)
draw(fig)
```

```{r loop for all data types}
####
# Main
####
# prefix <- 'I:CNVR'
pre <- c('I:CNVR', 'N:METH' , 'N:GEXP', 'B:MUTA', 'N:MIR')
for (prefix in pre){
  # A. Order by subtype
  df_transform <- df %>% arrange(Labels)
  
  # B. Column annotation
  column_ha <- HeatmapAnnotation(
    Subtype = df_transform$Labels, 
    na_col = 'grey', 
    col = list(
      Subtype = c(
        "BRCA_1" = 'royalblue4',
        "BRCA_2"='royalblue1',
        "BRCA_3"='paleturquoise3',
        "BRCA_4"='paleturquoise1'
      )
    )
  )
  
  # C. Select data type
  df_transform <- df_transform %>%
      select(-Labels) %>%
      select(-all_of(cancer)) %>%
      select(starts_with(prefix))
  mat <- df_transform %>%
      as.matrix() %>%
      t()
  print(prefix)
  n_fts <- nrow(mat)
  print(n_fts)
  
  # 1. Heatmap that applies clustering we want
  #    second heatmap same row/col order but with added annotation bars
  fig <- Heatmap(
    mat,
    name = 'first heatmap',
    cluster_rows = TRUE,
    cluster_columns = FALSE,
    show_row_names = FALSE,
    show_column_names = FALSE,
    column_title = 'Samples',
    row_title = 'Features',
    top_annotation = column_ha
  )
  draw(fig)
  
  #### 
  # new
  ####
  
  # Ordering
  # 1. Get order of features post heatmap clustering
  heatmap_order <- row_order(fig) # index vector
  ftnames_order <- c() # featurename vector
  for (i in heatmap_order){
    add_ft <- colnames(df_transform)[i]
    ftnames_order <- c(ftnames_order, add_ft)
  }
  print(ftnames_order)
  # 2. Get new matrix that is ordered by heatmap clustering
  mat2 <- mat[match(ftnames_order, rownames(mat)),]
  
  
  
  # Build annotation bars of teams feature sets. 
  # 1. df of all teams. match ft order in heatmap
  team_df<- df_fts %>% filter(featureID %in% ftnames_order) %>% arrange(match(featureID, ftnames_order))
  # 2. Pull just the team of interest
  jadbio <- team_df %>% pull('gnosis_1_BRCA') %>% as.character()
  cforest <- team_df %>% pull('CF|All_Top 100_BRCA') %>% as.character()
  aklimate <- team_df %>% pull('AKLIMATE_BRCA_reduced_model_1000_feature_set_BRCA') %>% as.character()
  subscope <- team_df %>% pull('nn_jg_2020-03-20_top1kfreq:BRCA_BRCA') %>% as.character()
  skgrid <- team_df %>% pull('fbedeBIC_BRCA') %>% as.character()
  team_list <- rowAnnotation(
    JadBIO = jadbio,
    CForest = cforest,
    AKLIMATE = aklimate,
    SubSCOPE = subscope,
    SKGrid = skgrid,
    col = list(
      JadBIO = c('0' = "snow2", '1' = "palevioletred1"),
      CForest =  c('0' = "snow2", '1' = "mediumpurple1"),
      AKLIMATE =  c('0' = "snow2", '1' = "cadetblue1"),
      SubSCOPE =  c('0' = "snow2", '1' = "palegreen2"),
      SKGrid =  c('0' = "snow2", '1' = "rosybrown2")
    ),
    show_legend = FALSE
  )
  # 3. Heatmap
  fig <- Heatmap(
    mat2,
    name = prefix,
    cluster_rows = FALSE,
    cluster_columns = FALSE,
    show_row_names = FALSE,
    show_column_names = FALSE,
    # rect_gp = gpar(col = "white", lwd = 2),
    column_title = 'Samples',
    row_title = 'Features',
    top_annotation = column_ha,
    right_annotation = team_list
  )
  draw(fig)
}
```